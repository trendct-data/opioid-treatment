{
    "collab_server" : "",
    "contents" : "---\ntitle: \"Opioid treatment checkins\"\nauthor: \"Andrew Ba Tran\"\ndate: \"October 4, 2016\"\noutput: html_document\n---\n\nQuestions to ask:\n\n- Which towns had the most admissions per capita?\n- Urban versus rural versus mixed admissions?\nIs there a correlation between admissions and overdose deaths? (By year)\n\nWhere do people tend to die (urban, rural, mixed)\n\ndistance to clinics, pharmacies, hospitals\n\ncorrelation between deaths and admissions to these distances?\n\n\n\n```{r setup, include=FALSE}\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(ctnamecleaner)\nlibrary(ggplot2)\nlibrary(extrafont)\nlibrary(scales)\nlibrary(rgdal)\nrequire(maptools)\nlibrary(stringr)\nlibrary(knitr)\nlibrary(lubridate)\nlibrary(\"censusapi\")\nsource(\"keys.R\")\n\ntreat <- read.csv(\"https://data.ct.gov/api/views/4pv7-jhxb/rows.csv?accessType=DOWNLOAD\", stringsAsFactors=F)\n\n```\n\n```{r total_town_year, message=F, warning=F, fig.width=8, fig.height=35}\n\ntreat$Admissions[is.na(treat$Admissions)] <- 0\n\ngg <- ggplot(treat, aes(y=Admissions, x=FiscalYear))\ngg <- gg + geom_bar(stat=\"identity\")\ngg <- gg + facet_wrap(~Town, ncol=4, scale=\"free_x\")\n#gg <- gg + facet_wrap(~state, scale=\"free\", ncol=5)\n#gg <- gg + scale_x_continuous(limits=c(2012,2016), breaks=c(2012,2016),\n#        labels=c(\"2012\", \"2016\"))\ngg <- gg + labs(x=NULL, y=NULL, \n                title=\"Opioid Related Treatment Admissions by Town\",\n                subtitle=\"\",\n                caption=\"Department of Mental Health and Addiction Services\")\ngg <- gg + theme_minimal(base_family=\"Lato Regular\")\ngg <- gg + theme(panel.grid.major.y=element_blank())\ngg <- gg + theme(panel.grid.minor=element_blank())\ngg <- gg + theme(plot.title=element_text(family=\"Lato Black\"))\ngg\n\n\n# gg <- ggplot(treat, aes(y=Unduplicated.Clients, x=FiscalYear))\n# gg <- gg + geom_bar(stat=\"identity\")\n# gg <- gg + facet_wrap(~Town, ncol=4, scale=\"free_x\")\n# #gg <- gg + facet_wrap(~state, scale=\"free\", ncol=5)\n# #gg <- gg + scale_x_continuous(limits=c(2012,2016), breaks=c(2012,2016),\n# #        labels=c(\"2012\", \"2016\"))\n# gg <- gg + labs(x=NULL, y=NULL, \n#                 title=\"Opioid Related Treatment Admissions (unduplicated clients) by Town\",\n#                 subtitle=\"\",\n#                 caption=\"Department of Mental Health and Addiction Services\")\n# gg <- gg + theme_minimal(base_family=\"Lato Regular\")\n# gg <- gg + theme(panel.grid.major.y=element_blank())\n# gg <- gg + theme(panel.grid.minor=element_blank())\n# gg <- gg + theme(plot.title=element_text(family=\"Lato Black\"))\n# gg\n```\n\n```{r total_town_year_per_capita, message=F, warning=F, fig.width=8, fig.height=35}\n\ntreat$Admissions[is.na(treat$Admissions)] <- 0\ntreat <- ctpopulator(Town, treat)\ntreat$per_capita_a <- round(treat$Admissions/treat$pop2013*1000, 2)\n\ngg <- ggplot(treat, aes(y=per_capita_a, x=FiscalYear))\ngg <- gg + geom_bar(stat=\"identity\")\ngg <- gg + facet_wrap(~Town, ncol=4, scale=\"free_x\")\n#gg <- gg + facet_wrap(~state, scale=\"free\", ncol=5)\n#gg <- gg + scale_x_continuous(limits=c(2012,2016), breaks=c(2012,2016),\n#        labels=c(\"2012\", \"2016\"))\ngg <- gg + labs(x=NULL, y=NULL, \n                title=\"Opioid Related Treatment Admissions per 1,000 residents by Town\",\n                subtitle=\"\",\n                caption=\"Department of Mental Health and Addiction Services\")\ngg <- gg + theme_minimal(base_family=\"Lato Regular\")\ngg <- gg + theme(panel.grid.major.y=element_blank())\ngg <- gg + theme(panel.grid.minor=element_blank())\ngg <- gg + theme(plot.title=element_text(family=\"Lato Black\"))\ngg\n```\n\n# Mapped\n\n```{r map1, message=F, warning=F, fig.width=9, fig.height=9}\n\ntown_shape <- readOGR(dsn=\"maps\", layer=\"ctgeo\")\ntown_shape_df <- fortify(town_shape, region=\"NAME10\")\n\nnames(treat)[names(treat) == 'Town'] <- 'id'\ntreat$id <- str_to_title(treat$id)\ntown_map <- left_join(town_shape_df, treat)\n\ngg <- ggplot(town_map, aes(long,lat, group=group, fill=per_capita_a)) \ngg <- gg +  geom_polygon()\ngg <- gg +  geom_path(color = \"grey73\")\ngg <- gg +  coord_equal()\ngg <- gg + facet_wrap(~FiscalYear, ncol=2)\ngg <- gg + scale_fill_gradient(low=\"grey73\", high=\"blue\") \ngg <- gg + labs(x=NULL, y=NULL, title=\"Opioid Related Treatment Admissions by town\",\n                subtitle=\"Per 1,000 residents\",\n                caption=\"SOURCE: Department of Mental Health and Addiction Services\\nAndrew Ba Tran/TrendCT.org\")\ngg <- gg + theme_bw(base_family=\"Lato Regular\")\ngg <- gg + theme(text = element_text(size=16))\ngg <- gg + theme(panel.grid.major=element_blank())\ngg <- gg + theme(panel.grid.minor=element_blank())\ngg <- gg + theme(panel.border=element_blank())\ngg <- gg + theme(axis.ticks=element_blank())\ngg <- gg + theme(axis.text.x=element_blank())\ngg <- gg + theme(axis.text.y=element_blank())\ngg <- gg + theme(plot.title=element_text(face=\"bold\", family=\"Lato Black\", size=22))\ngg <- gg + theme(plot.subtitle=element_text(face=\"italic\", size=9, margin=margin(b=12)))\ngg <- gg + theme(plot.caption=element_text(size=12, margin=margin(t=10, r=80), color=\"#7a7d7e\"))\ngg <- gg + theme(plot.margin = unit(c(1, 1, 1, 1), \"lines\"))\n\ngg\n\n```\n\n# Towns with most check-ins per capita\n\n```{r table1}\ntab1 <- treat %>%\n  select(id, FiscalYear, per_capita_a) %>%\n  spread(FiscalYear, per_capita_a) %>%\n  arrange(-`2016`)\n  kable(head(tab1, 10))\n```\n\n# Check-ins by town type\n\n```{r town_type1, fig.width=9, fig.height=5, warning=F, message=F} \nsource(\"urban_rural_mixed.R\")\n\ntown_count <- town_count[c(\"NAME10\", \"Type\", \"perc_urban\")]\ncolnames(town_count) <- c(\"id\", \"town_type\", \"perc_urban\")\n\ntab2 <- treat %>%\n  select(id, FiscalYear, Admissions, pop2013, per_capita_a)\n\ntab2_joined <- left_join(tab2, town_count)\n\ngg <- ggplot(tab2_joined, aes(x=town_type, y=Admissions,fill=town_type))\ngg <- gg +  geom_boxplot()\ngg <- gg +  facet_wrap(~FiscalYear, ncol=5)\ngg <- gg + labs(x=NULL, y=\"Admissions\", title=\"Overall opioid-related checkins in Connecticut\",\n                subtitle=\"Per 1,000 residents\",\n                caption=\"SOURCE: Department of Mental Health and Addiction Services\\nAndrew Ba Tran/TrendCT.org\")\ngg <- gg + theme_bw(base_family=\"Lato Regular\")\ngg <- gg + theme(text = element_text(size=16))\ngg <- gg + theme(panel.grid.major=element_blank())\ngg <- gg + theme(panel.grid.minor=element_blank())\ngg <- gg + theme(panel.border=element_blank())\ngg <- gg +  theme(axis.text.x=element_text(angle=90, vjust=0.4,hjust=1))\n#gg <- gg + theme(axis.ticks=element_blank())\n#gg <- gg + theme(axis.text.y=element_blank())\ngg <- gg + theme(plot.title=element_text(face=\"bold\", family=\"Lato Black\", size=22))\ngg <- gg + theme(plot.subtitle=element_text(face=\"italic\", size=9, margin=margin(b=12)))\ngg <- gg + theme(plot.caption=element_text(size=12, margin=margin(t=10, r=80), color=\"#7a7d7e\"))\ngg <- gg + theme(plot.margin = unit(c(1, 1, 1, 1), \"lines\"))\n\ngg\n\np <- ggplot(tab2_joined, aes(x=town_type, y=per_capita_a,fill=town_type))\ngg <- gg +  geom_boxplot()\ngg <- gg +  facet_grid(.~FiscalYear)\ngg <- gg + labs(x=NULL, y=\"Admissions per capita\", title=\"Overall opioid-related checkins in Connecticut\",\n                subtitle=\"Per 1,000 residents\",\n                caption=\"SOURCE: Department of Mental Health and Addiction Services\\nAndrew Ba Tran/TrendCT.org\")\ngg <- gg + theme_bw(base_family=\"Lato Regular\")\ngg <- gg + theme(text = element_text(size=16))\ngg <- gg + theme(panel.grid.major=element_blank())\ngg <- gg + theme(panel.grid.minor=element_blank())\ngg <- gg + theme(panel.border=element_blank())\ngg <- gg + theme(axis.text.x=element_text(angle=90, vjust=0.4,hjust=1))\n#gg <- gg + theme(axis.ticks=element_blank())\n#gg <- gg + theme(axis.text.y=element_blank())\ngg <- gg + theme(plot.title=element_text(face=\"bold\", family=\"Lato Black\", size=22))\ngg <- gg + theme(plot.subtitle=element_text(face=\"italic\", size=9, margin=margin(b=12)))\ngg <- gg + theme(plot.caption=element_text(size=12, margin=margin(t=10, r=80), color=\"#7a7d7e\"))\ngg <- gg + theme(plot.margin = unit(c(1, 1, 1, 1), \"lines\"))\n\ngg\n```\n\n## Looking at deaths\n\nPrepping the data\n```{r deaths, message=F, warning=F, fig.width=8, fig.height=30}\ndrug_deaths <- read.csv(\"https://data.ct.gov/api/views/rybz-nyjw/rows.csv?accessType=DOWNLOAD\", stringsAsFactors = F)\n\n# Cleaning up race\ndrug_deaths$R <- \"Unknown\"\ndrug_deaths$R <- ifelse(drug_deaths$Race==\"Asian Indian\", \"Asian\", drug_deaths$R)\ndrug_deaths$R <- ifelse(drug_deaths$Race==\"Asian, Other\", \"Asian\", drug_deaths$R)\ndrug_deaths$R <- ifelse(drug_deaths$Race==\"Chinese\", \"Asian\", drug_deaths$R)\ndrug_deaths$R <- ifelse(drug_deaths$Race==\"Hispanic, Black\", \"Hispanic\", drug_deaths$R)\ndrug_deaths$R <- ifelse(drug_deaths$Race==\"Hispanic, White\", \"Hispanic\", drug_deaths$R)\ndrug_deaths$R <- ifelse(drug_deaths$Race==\"Hispanic, Black\", \"Hispanic\", drug_deaths$R)\ndrug_deaths$R <- ifelse(drug_deaths$Race==\"Native American, Other\", \"Other\", drug_deaths$R)\ndrug_deaths$R <- ifelse(drug_deaths$Race==\"\", \"Unknown\", drug_deaths$R)\ndrug_deaths$R <- ifelse(drug_deaths$Race==\"Asian\", \"Asian\", drug_deaths$R)\ndrug_deaths$R <- ifelse(drug_deaths$Race==\"Black\", \"Black\", drug_deaths$R)\ndrug_deaths$R <- ifelse(drug_deaths$Race==\"Hispanic\", \"Hispanic\", drug_deaths$R)\ndrug_deaths$R <- ifelse(drug_deaths$Race==\"White\", \"White\", drug_deaths$R)\n\n# Cleaning up death and residence city locations\n\ndrug_deaths <- ctnamecleaner(Death.City, drug_deaths)\nnames(drug_deaths)[names(drug_deaths) == 'real.town.name'] <- 'town.of.death'\ndrug_deaths$Residence.City <- gsub(\"  \", \" \", drug_deaths$Residence.City)\ndrug_deaths <- ctnamecleaner(Residence.City, drug_deaths)\nnames(drug_deaths)[names(drug_deaths) == 'real.town.name'] <- 'town.of.residence'\ndrug_deaths$residence.and.death <- \"\"\ndrug_deaths$residence.and.death <- ifelse(drug_deaths$town.of.death == drug_deaths$town.of.residence, \"Same town of death and residence\", \"Different town of death than residence\")\ndrug_deaths$residence.and.death <- ifelse(is.na(drug_deaths$town.of.death), \"Town of death unknown\", drug_deaths$residence.and.death)\ndrug_deaths$residence.and.death <- ifelse(is.na(drug_deaths$town.of.residence), \"Residence unknown\", drug_deaths$residence.and.death)\ndrug_deaths$residence.and.death <- ifelse((is.na(drug_deaths$town.of.residence) & (drug_deaths$Residence.State!=\"CT\")), \"Out of town resident, local death\", drug_deaths$residence.and.death)\ndrug_deaths$residence.and.death <- ifelse((is.na(drug_deaths$town.of.residence) & (drug_deaths$Residence.City==\"\")), \"Unknown residence\", drug_deaths$residence.and.death)\n\ndrug_deaths$date.fixed <- mdy(drug_deaths$Date)\ndrug_deaths$Year <- year(drug_deaths$date.fixed)\ndrug_deaths$row <- row.names(drug_deaths)\n\n# fentanyl only\nnew_fentanyl <- drug_deaths %>%\n  mutate(cause=str_to_lower(drug_deaths$ImmediateCauseA)) %>%\n  filter(grepl(\"fent\", cause) | Fentanyl==\"Y\" )\n\nnew_fent <-  select(new_fentanyl, row)\nnew_fent$update_fent <- \"Yes\"\nnew_fent <- as.data.frame(new_fent)\ndrug_deaths <- left_join(drug_deaths, new_fent)\n  \n# heroin only\n\nnew_heroin <- drug_deaths %>%\n  mutate(cause=str_to_lower(drug_deaths$ImmediateCauseA)) %>%\n  filter(grepl(\"heroin\", cause) | Heroin==\"Y\" )\n\nnew_her <- select(new_heroin, row)\nnew_her$update_heroin <- \"Yes\"\nnew_her <- as.data.frame(new_her)\ndrug_deaths <- left_join(drug_deaths, new_her)\n\n# prescription opioids\n\nnew_presc <- drug_deaths %>%\n  mutate(cause=str_to_lower(drug_deaths$ImmediateCauseA)) %>%\n  filter(grepl(\"oxy\", cause) | Oxycodone==\"Y\" | Oxymorphone==\"Y\" |\n           grepl(\"hydro\", cause) | Hydrocodone==\"Y\" |\n           grepl(\"tramad\", cause) | Tramad==\"Y\" |\n           grepl(\"morphine\", cause) | Morphine..not.heroin.==\"Y\" )\n\n\nnew_pre <- select(new_presc, row)\nnew_pre$update_presc <- \"Yes\"\nnew_pre <- as.data.frame(new_pre)\ndrug_deaths <- left_join(drug_deaths, new_pre)\n\n#leftover <- subset(drug_deaths, is.na(update_fent) & is.na(update_heroin) & is.na(update_presc))\n#ggplot(leftover, aes(Year)) + geom_bar()\n\n# There were about 461 cases that did not involve overdoses of prescription opioids, heroin, or fentanyl\n\n# OK, checkins and deaths by year and town\n\n\n# Prepping town and year dataframe\n\ntowns_only <- data.frame(town_count[,1])\ncolnames(towns_only) <- \"town.of.residence\"\ntowns_only$Year <- 0\n\nfor (i in 2012:2016) {\n  towns_only$Year <- i\n  if (i == 2012) {\n    mega_towns <- towns_only\n  } else {\n    mega_towns <- rbind(mega_towns, towns_only)\n  }\n}\n\n# First, deaths by town (just opioids)\n\nopioid_deaths <- drug_deaths %>%\n  filter(update_presc==\"Yes\") %>%\n  group_by(town.of.residence, Year) %>%\n  summarise(overdose.deaths=n())\n# \ncheckins <- tab2\ncolnames(checkins) <- c(\"town.of.residence\", \"Year\", \"admissions\", \"pop\", \"per_capita_a\")\n\ntest <- left_join(mega_towns, checkins)\ntest <- left_join(test, opioid_deaths)\n\ncor(test$admissions, test$overdose.deaths, use=\"complete.obs\")\ncor(test$per_capita_a, test$overdose.deaths, use=\"complete.obs\")\ntest2 <- test\ntest2$per_capita_o <- round(test2$overdose.deaths/test2$pop*10000,2)\ntest2$overdose.deaths[is.na(test2$overdose.deaths)] <- 0\ncor(test2$admissions, test2$overdose.deaths, use=\"complete.obs\")\ncor(test2$per_capita_a, test2$overdose.deaths, use=\"complete.obs\")\ncor(test2$per_capita_a, test2$per_capita_o, use=\"complete.obs\")\n\ntest3 <- test2 %>%\n  select(town.of.residence, Year, per_capita_a, per_capita_o) %>%\n  gather(\"Type\", \"per.capita\", 3:4)\n\ngg <- ggplot(test3, aes(x=Year, y=per.capita, group=Type, color=Type))\ngg <- gg + geom_line()\ngg <- gg + facet_wrap(~town.of.residence, scales=\"free\", ncol=5)\ngg\n\ntest4 <- test2 %>%\n  select(town.of.residence, Year, admissions, overdose.deaths) %>%\n  gather(\"Type\", \"Count\", 3:4)\n\ngg <- ggplot(test4, aes(x=Year, y=Count, group=Type, color=Type))\ngg <- gg + geom_line()\ngg <- gg + facet_wrap(~town.of.residence, scales=\"free\", ncol=5)\ngg\n```\n\n\n```{r town_totals}\n\nopioid_deaths2 <- drug_deaths %>%\n  filter(update_presc==\"Yes\") %>%\n  group_by(town.of.residence) %>%\n  summarise(overdose.deaths=n())\n# \ncheckins <- tab2\ncolnames(checkins) <- c(\"town.of.residence\", \"Year\", \"admissions\", \"pop\", \"per_capita_a\")\n\ncheckins2 <- checkins %>%\n  group_by(town.of.residence) %>%\n  summarise(admissions=sum(admissions))\n\ntown_totals <- left_join(towns_only, opioid_deaths2)\ntown_totals <- left_join(town_totals, checkins2)\n\n\ncor(town_totals$admissions, town_totals$overdose.deaths, use=\"complete.obs\")\ntown_totals <- ctpopulator(town.of.residence, town_totals)\n\ntown_totals$per_cap_o <- round(town_totals$overdose.deaths/town_totals$pop2013*1000,2)\ntown_totals$per_cap_a <- round(town_totals$admissions/town_totals$pop2013*1000,2)\ncor(town_totals$per_cap_a, town_totals$per_cap_o, use=\"complete.obs\")\n\ngg <- ggplot(town_totals, aes(x=overdose.deaths, y=admissions))\ngg <- gg + geom_point()\ngg <- gg + labs(x=\"Overdoses\", y=\"Admissions\", \n                title=\"Overdose deaths compared to clinical admissions by town\",\n                subtitle=\"\",\n                caption=\"Department of Mental Health and Addiction Services\")\ngg\n\ngg <- ggplot(town_totals, aes(x=per_cap_o, y=per_cap_a))\ngg <- gg + geom_point()\ngg <- gg + labs(x=\"Overdoses per capita\", y=\"Admissions per capita\", \n                title=\"Overdose deaths compared to clinical admissions by town (per 1,000 residents)\",\n                subtitle=\"\",\n                caption=\"Department of Mental Health and Addiction Services\")\ngg\n\n```\n\n\n# Income\n\n\n```{r towns_income_admissions}\n\n\nvars2014 <- listCensusMetadata(name=\"acs5\", vintage=2014, \"v\")\nView(vars2014)\n\ndata2014 <- getCensus(name=\"acs5\", \n                      vintage=2014,\n                      key=census_key, \n                      vars=c(\"NAME\", \"B19013_001E\"), \n                      region=\"county subdivision:*\",  regionin=\"state:09\")\ndata2014$town.of.residence <- gsub(\" town.*\", \"\", data2014$NAME)\ndata2014 <- subset(data2014, !is.na(B19013_001E))\ndata2014 <- data2014[,5:6]\n\ncolnames(data2014) <- c(\"median.income\", \"town.of.residence\")\n\ntown_totals2 <- town_totals \ntown_totals2$town.of.residence <- str_to_title(town_totals2$town.of.residence)\ntown_totals2 <- left_join(town_totals2, data2014)\n\ncor(town_totals2$per_cap_a, town_totals2$median.income, use=\"complete.obs\")\n\ngg <- ggplot(town_totals2, aes(x=median.income, y=per_cap_o))\ngg <- gg + geom_point()\ngg <- gg + labs(x=\"Median income\", y=\"Admissions per capita\", \n                title=\"Clinical admissions by town (per 1,000 residents) compared to median income\",\n                subtitle=\"\",\n                caption=\"Department of Mental Health and Addiction Services\")\ngg\n\n\n```\n\n\n```{r box3}\n\n# join test to urban dataframe, whatever that is\n# \n# p <- ggplot(tab2_joined, aes(x=town_type, y=per_capita_a,fill=town_type))\n# gg <- gg +  geom_boxplot()\n# gg <- gg +  facet_grid(.~FiscalYear)\n# gg <- gg + labs(x=NULL, y=\"Admissions per capita\", title=\"Overall opioid-related checkins in Connecticut\",\n#                 subtitle=\"Per 1,000 residents\",\n#                 caption=\"SOURCE: Department of Mental Health and Addiction Services\\nAndrew Ba Tran/TrendCT.org\")\n# gg <- gg + theme_bw(base_family=\"Lato Regular\")\n# gg <- gg + theme(text = element_text(size=16))\n# gg <- gg + theme(panel.grid.major=element_blank())\n# gg <- gg + theme(panel.grid.minor=element_blank())\n# gg <- gg + theme(panel.border=element_blank())\n# gg <- gg + theme(axis.text.x=element_text(angle=90, vjust=0.4,hjust=1))\n# #gg <- gg + theme(axis.ticks=element_blank())\n# #gg <- gg + theme(axis.text.y=element_blank())\n# gg <- gg + theme(plot.title=element_text(face=\"bold\", family=\"Lato Black\", size=22))\n# gg <- gg + theme(plot.subtitle=element_text(face=\"italic\", size=9, margin=margin(b=12)))\n# gg <- gg + theme(plot.caption=element_text(size=12, margin=margin(t=10, r=80), color=\"#7a7d7e\"))\n# gg <- gg + theme(plot.margin = unit(c(1, 1, 1, 1), \"lines\"))\n# \n# gg\n```\n",
    "created" : 1475607324142.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3639945166",
    "id" : "E70A1809",
    "lastKnownWriteTime" : 1475697036,
    "last_content_update" : 1475697036532,
    "path" : "~/Documents/Github/trendct-data/2016/10/opioid-treatment/index.Rmd",
    "project_path" : "index.Rmd",
    "properties" : {
        "tempName" : "Untitled2"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}